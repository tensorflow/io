# Description:
#   NASM is a portable assembler in the Intel/Microsoft tradition.

licenses(["notice"])  # BSD 2-clause

exports_files(["LICENSE"])

cc_binary(
    name = "nasm",
    srcs = glob([
        "include/*.h",
        "asm/*.c",
        "asm/*.h",
        "common/*.c",
        "common/*.h",
        "macros/*.c",
        "macros/*.h",
        "nasmlib/*.h",
        "nasmlib/*.c",
        "output/*.c",
        "output/*.h",
        "x86/*.c",
        "x86/*.h",
        "stdlib/strlcpy.c",
        "stdlib/strrchrnul.c",
        "config/msvc.h",
        "version.h",
    ]) + select({
        "@bazel_tools//src/conditions:windows": [],
        "//conditions:default": [
            "build/config/config.h",
        ],
    }),
    copts = select({
        "@bazel_tools//src/conditions:windows": [],
        "//conditions:default": [
            "-w",
            "-std=c99",
        ],
    }),
    defines = select({
        "@bazel_tools//src/conditions:windows": [],
        "//conditions:default": [
            "HAVE_CONFIG_H=1",
        ],
    }),
    includes = [
        "asm",
        "build",
        "include",
        "output",
        "x86",
    ],
    visibility = ["//visibility:public"],
)

genrule(
    name = "configure",
    outs = ["build/config/config.h"],
    cmd = "\n".join([
        "cat <<'EOF' >$@",
        "",
        "#define HAVE_ACCESS 1",
        "#define HAVE_DECL_STRCASECMP 1",
        "#define HAVE_DECL_STRICMP 0",
        "#define HAVE_DECL_STRNCASECMP 1",
        "#define HAVE_DECL_STRNICMP 0",
        "#define HAVE_DECL_STRNLEN 1",
        "#define HAVE_DECL_STRSEP 1",
        "#define HAVE_FACCESSAT 1",
        "#define HAVE_FCNTL_H 1",
        "#define HAVE_FILENO 1",
        "#define HAVE_FSEEKO 1",
        "#define HAVE_FSTAT 1",
        "#define HAVE_FTRUNCATE 1",
        "#define HAVE_FUNC_ATTRIBUTE_ALLOC_SIZE 1",
        "#define HAVE_FUNC_ATTRIBUTE_CONST 1",
        "#define HAVE_FUNC_ATTRIBUTE_FORMAT 1",
        "#define HAVE_FUNC_ATTRIBUTE_MALLOC 1",
        "#define HAVE_FUNC_ATTRIBUTE_NORETURN 1",
        "#define HAVE_FUNC_ATTRIBUTE_PURE 1",
        "#define HAVE_FUNC_ATTRIBUTE_RETURNS_NONNULL 1",
        "#define HAVE_GETGID 1",
        "#define HAVE_GETPAGESIZE 1",
        "#define HAVE_GETUID 1",
        "#define HAVE_INTTYPES_H 1",
        "#define HAVE_MEMORY_H 1",
        "#define HAVE_MMAP 1",
        "#define HAVE_PATHCONF 1",
        "#define HAVE_REALPATH 1",
        "#define HAVE_SNPRINTF 1",
        "#define HAVE_STAT 1",
        "#define HAVE_STDBOOL_H 1",
        "#define HAVE_STDINT_H 1",
        "#define HAVE_STDLIB_H 1",
        "#define HAVE_STDNORETURN_H 1",
        "#define HAVE_STRCASECMP 1",
        "#define HAVE_STRINGS_H 1",
        "#define HAVE_STRING_H 1",
        "#define HAVE_STRNCASECMP 1",
        "#define HAVE_STRNLEN 1",
        "#define HAVE_STRSEP 1",
        "#define HAVE_STRUCT_STAT 1",
        "#define HAVE_SYSCONF 1",
        "#define HAVE_SYS_MMAN_H 1",
        "#define HAVE_SYS_PARAM_H 1",
        "#define HAVE_SYS_STAT_H 1",
        "#define HAVE_SYS_TYPES_H 1",
        "#define HAVE_UINTPTR_T 1",
        "#define HAVE_UNISTD_H 1",
        "#define HAVE_VSNPRINTF 1",
        "#define HAVE__BOOL 1",
        "#define HAVE___BUILTIN_CLZ 1",
        "#define HAVE___BUILTIN_CLZL 1",
        "#define HAVE___BUILTIN_CLZLL 1",
        "#define HAVE___BUILTIN_EXPECT 1",
        '#define PACKAGE_BUGREPORT ""',
        '#define PACKAGE_NAME ""',
        '#define PACKAGE_STRING ""',
        '#define PACKAGE_TARNAME ""',
        '#define PACKAGE_URL ""',
        '#define PACKAGE_VERSION ""',
        "#define STDC_HEADERS 1",
        "#ifndef _ALL_SOURCE",
        "# define _ALL_SOURCE 1",
        "#endif",
        "#ifndef _GNU_SOURCE",
        "# define _GNU_SOURCE 1",
        "#endif",
        "#ifndef _POSIX_PTHREAD_SEMANTICS",
        "# define _POSIX_PTHREAD_SEMANTICS 1",
        "#endif",
        "#ifndef _TANDEM_SOURCE",
        "# define _TANDEM_SOURCE 1",
        "#endif",
        "#ifndef __EXTENSIONS__",
        "# define __EXTENSIONS__ 1",
        "#endif",
        "#define WORDS_LITTLEENDIAN 1",
        "#ifndef _DARWIN_USE_64_BIT_INODE",
        "# define _DARWIN_USE_64_BIT_INODE 1",
        "#endif",
        "#ifndef __cplusplus",
        "#endif",
        "#define restrict __restrict",
        "#if defined __SUNPRO_CC && !defined __RESTRICT",
        "# define _Restrict",
        "# define __restrict__",
        "#endif",
        "",
        "EOF",
    ]),
)
