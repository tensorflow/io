name: GitHub CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  BAZEL_VERSION: 2.0.0
  BAZEL_OPTIMIZATION: --copt=-msse4.2 --copt=-mavx --compilation_mode=opt

jobs:
  windows-bazel:
    name: Bazel Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v1
      - uses: numworks/setup-msys2@v1
      - uses: actions/setup-python@v1
        with:
          python-version: 3.7.5
      - name: Bazel on Windows
        shell: cmd
        env:
          PYTHON_VERSION: 3.7.5
        run: |
          @echo on
          curl -sSOL https://github.com/bazelbuild/bazel/releases/download/%BAZEL_VERSION%/bazel-%BAZEL_VERSION%-windows-x86_64.exe
          echo export BAZEL_VC=/c/Program\ Files\ \(x86\)/Microsoft\ Visual\ Studio/2019/Enterprise/VC/  >>D:\a\_temp\msys\msys64\home\runneradmin\.bash_profile
          echo export BAZEL_PATH=/d/a/io/io/bazel-%BAZEL_VERSION%-windows-x86_64.exe  >>D:\a\_temp\msys\msys64\home\runneradmin\.bash_profile
          echo export PATH=/c/hostedtoolcache/windows/Python/%PYTHON_VERSION%/x64/:$PATH  >>D:\a\_temp\msys\msys64\home\runneradmin\.bash_profile
          which python
          cp /c/hostedtoolcache/windows/Python/%PYTHON_VERSION%/x64/python /c/hostedtoolcache/windows/Python/%PYTHON_VERSION%/x64/python3
          python3 --version
          python3 -m pip install wheel setuptools
          python3 -m pip --version
          python3 setup.py --package-version | xargs python3 -m pip install
          python3 tools/build/configure.py
          cat .bazelrc
          msys2do .github/workflows/build.windows.sh
      - uses: actions/upload-artifact@v1
        with:
          name: ${{ runner.os }}-bazel-bin
          path: bazel-bin/tensorflow_io

  windows-wheel:
    name: Wheel ${{ matrix.python }} Windows
    needs: windows-bazel
    runs-on: windows-latest
    strategy:
      matrix:
        python: ['3.7']
    steps:
      - uses: actions/checkout@v1
      - uses: numworks/setup-msys2@v1
      - uses: actions/download-artifact@v1
        with:
          name: ${{ runner.os }}-bazel-bin
          path: bazel-bin/tensorflow_io
      - uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python }}
      - name: Wheel ${{ matrix.python }} Windows
        shell: cmd
        run: |
          @echo on
          python --version
          python -m pip install -U wheel setuptools
          python setup.py --data bazel-bin -q bdist_wheel
          ls -la dist
      - uses: actions/upload-artifact@v1
        with:
          name: ${{ runner.os }}-${{ matrix.python }}-wheel
          path: dist
      - name: Install ${{ matrix.python }} Windows
        shell: cmd
        run: |
          @echo on
          python --version
          (cd dist && find . -name "*.whl" | xargs python -m pip install)
      - name: Test ${{ matrix.python }} Windows
        shell: cmd
        run: |
          @echo on
          python --version
          python -m pip install -U pytest
          rm -rf tensorflow_io
          (cd tests && python -m pytest -s -v test_text_eager.py -k re2)
